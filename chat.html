<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>WebStream Chat!</title>
    <style>
        .presence {
            color: green;
            font-family: monospace;
        }
        
        .time {
            font-size: 10pt;
            font-family: monospace;
            color: gray;
        }

        .error {
            font-weight: bolder;
            font-family: monospace;
            color: red;
        }
    </style>
</head>
<body>
    <script src="http://code.jquery.com/jquery-1.7.min.js" type="text/javascript"></script>
    <script src="Scripts/rx.js"></script>
    <!--<script src="Scripts/rx.async.js"></script>
    <script src="Scripts/rx.binding.js"></script>
    <script src="Scripts/rx.binding.js"></script>-->
    <script src="Scripts/webstream.js"></script>
    <script type="text/javascript">
        $(function () {
            // Pipe all rooms into the 'rooms' dropdown.
            WebStream('/chat/rooms').distinct().subscribe(function (room) {
                // Default to the first room.
                if (!$('#room').val()) {
                    $('#room').val(room);
                }

                // Append new rooms.
                $('#rooms').append($('<option>').val(room).text(room));
            });

        // When a room is selected, populate the room input box.
        $('#rooms').change(function() {
            $('#rooms option:selected').each(function() {
                $('#room').val($(this).text());
            });
        });

        $('#joinForm').submit(function(event) {
            if (event) {
                event.preventDefault();
            }
            
            // Create a new stream for sending messages.
            var inputs = { messages: new Rx.Subject() };

            // Join the chat room.
            var room = WebStream('/chat/join', { room: $('#room').val(), user: $('#user').val() }, inputs);

            // Append new events to the chat window.
            room.subscribe(
                function(chatEvent) {
                    var time = chatEvent.time.replace('T', ' ');
                    time = time.slice(0, time.indexOf('.'));

                    // jQuery isn't so chic anymore, but it's more than fine for this demo.
                    $('#messages').append(
                        $('<span>').append(
                            $('<span>').addClass('time').text(time),
                            $('<strong>').text(' ' + chatEvent.user),
                            $('<span>').addClass(chatEvent.type).text(' ' + chatEvent.message),
                            $('<br>')));
                },
                function(error) {
                    $('#messages').append(
                        $('<span>').addClass('error').append(
                            $('<strong>').text('Error'),
                            $('<span>').text(': ' + error))
                    );
                });

            // Wire up the message form to send messages on submit.
            $('#messageForm').submit(function (event) {
                if (event) {
                    event.preventDefault();
                }

                // Send the message text to the room and clear the input box.
                var $msgBox = $('#msg');
                inputs.messages.onNext($msgBox.val());
                $msgBox.val('');
            });
            
        });
    });
    </script>
    
    <div>
        <form id="joinForm">
            <input type="text" id="user" placeholder="Nickname" />
            <div><input type="text" id="room" placeholder="Room" />&nbsp;or&nbsp;<select id="rooms"></select></div>
            <button type="submit">Join</button>
        </form>
    </div>
    <div id="messages" style="border: 1px solid black; height:400px; width: 800px;"></div>
    <div><form id="messageForm"><input type="text" id="msg" style="width:500px" placeholder="Message"/><button type="submit">Send</button></form></div>
</body>
</html>
